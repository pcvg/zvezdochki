name: Tests
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  checks:
    name: Run tests and linters
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y libcairo2-dev libjpeg-dev libpango1.0-dev libgif-dev librsvg2-dev
          npm install

      - name: Run linters
        run: npm run lint

      - name: Run test
        if: ${{ github.actor != 'dependabot[bot]' }}
        run: npm run test-with-report

      - name: Run test without report
        if: ${{ github.actor == 'dependabot[bot]' }}
        run: npm run test

      - name: Run build
        if: ${{ github.actor == 'dependabot[bot]' }}
        run: npm run build

  comment-on-failure:
    runs-on: ubuntu-latest
    needs: [checks]
    if: failure() && github.event_name != 'workflow_dispatch'
    name: Comment on PR
    permissions:
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const message = `Tests failed, triggered by ${{ github.actor }} with '${{ github.event.action || github.event_name }}' event. ðŸš¨\n\nWorkflow run: ${runUrl}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  auto-merge-dependabot:
    runs-on: ubuntu-latest
    needs: [checks]
    if: success() && github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'
    name: Auto-merge Dependabot PR
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });

